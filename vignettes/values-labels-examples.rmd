---
title: "Format values and labels in examples"
author: "Martin Cadek"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Format values and labels in examples}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

```{r, echo=FALSE}
knitr::opts_chunk$set(comment = "#")
```

```{css, echo=FALSE}
.reveal .r code {
  white-space: pre;
}
```

```{r, message=FALSE}
library(rtables)
library(dplyr)
ADSL <- ex_adsl %>%
    mutate(ARM = factor(ARM), SEX = factor(SEX))
```

### Format Examples

The  section will showcase examples of `list_valid_format_labels()` and `list_valid_aligns()`.

We support `xx` style format labels grouped by 1d, 2d and 3d. Currently valid format labels can not be added dynamically. Format functions must be used for special cases.

Let's use the following simple example of `ADSL` data frame. 

```{r adsl_analyzed, echo=FALSE}
lyt_no_format <- basic_table() %>%
  split_cols_by("ARM") %>%
  split_rows_by("SEX") %>%
  analyze(vars = "AGE", afun = mean)

adsl_analyzed <- build_table(lyt_no_format, ADSL)

adsl_analyzed
```

In order to make these examples as simple as possible, we will define all formats on the [parent level](https://insightsengineering.github.io/rtables/main/articles/format_precedence.html#parent-table-format-and-inheritance) as seen in section above.


#### Examples of 1d labels

When you run `list_valid_format_labels()`, you will see several pre-defined valid format labels for 1d tables. These can be separated into four categories.

The first is the default value:
1. "xx": This is the default option for formatting. It indicates that an element of the raw value will be printed as is, with no modification.

The following formats can be used to display values with zero to four decimal places:
2. "xx.": This format indicates the raw value will be printed with zero decimal places. For example, if the raw value is "25.123456", it will be formatted as "25".
3. "xx.x": This format is used to print the raw value with one decimal place. For example, if the raw value is "25.123456", it will be formatted as "25.1".
4. "xx.xx": This format is used to print the raw value two decimal places. For example, if the value is "25.123456", it will be formatted as "25.12".
5. "xx.xxx": This format is used to print the raw value with three decimal places. For example, if the value is "25.123456", it will be formatted as "25.123".
6. "xx.xxxx": This format is used to print the raw value with four decimal places. For example, if the value is "25.123456", it will be formatted as "25.1234".

The following formats can be used to display values with zero to four decimal places which are in percentage format:
7. "xx%": This is identical to the default option, however, it will add % symbol to the raw value.
8. "xx.%": This format indicates the raw value will be printed with zero decimal places as percentages. For example, if the value is "0.25123456", it will be formatted as "25%".
9. "xx.x%": This format is used for percentages with one decimal place. For example, if the value is "0.25123456", it will be formatted as "25.1%".
10. "xx.xx%": This format is used for percentages with two decimal places. For example, if the value is "0.25123456", it will be formatted as "25.12%".
11. "xx.xxx%": This format is used for percentages with three decimal places. For example, if the value is "0.25123456", it will be formatted as "25.123%".

The following formats can be used to display miscellaneous values that can be used in statistical tables:
12. "(N=xx)": This format is used to denotate that the raw value refers to a sample. For example, if the raw value is 25, it will be formatted as "(N=25)".
13. ">999.9": This format is used when the value exceeds a certain threshold and only one decimal place is shown. For example, if the value is 1000.4, it will be formatted as ">999.9".
14. ">999.99": Similar to the previous format but with two decimal places. For example, if the value is 1000.46, it will be formatted as ">999.99".
15. "x.xxxx | (<0.0001)": This format is used for displaying a number with four decimal places or indicating a value less than a threshold. For example, if the value is 0.00005, it will be formatted as "<0.0001". If the value is 0.0005, it will be formatted as "0.0005".


To explore these pre-defined formats, let's start by defining a simple table layout which will be used in all of our examples. The table intentionally excludes `analyze` call from the pipe chain. This will allow us to use the same layout for all examples. Normally, you would include it in the first call.

```{r default_lyt, echo=FALSE}
lyt_default <- basic_table() %>%
    split_cols_by("ARM") %>%
    split_rows_by("SEX") # Excluding analyze

# Lyt with analyze and default format value called explicitly
lyt_default %>% 
    analyze(vars = "AGE", afun = mean, format = "xx") %>%
    build_table(ADSL)
```

Notice, that since we are using the default format value, the output table is simply passing the values through without any formatting.

##### Zero to Four Decimal Places

The following formats can be used to display values with zero to four decimal places:

```{r, echo=FALSE}
fmt_xx <- "xx."
fmt_xx_x <- "xx.x"
fmt_xx_xx <- "xx.xx"
fmt_xx_xxx <- "xx.xxx"
fmt_xx_xxxx <- "xx.xxxx"

# Apply is used to quickly iterate over the list of formats defined above.
lapply(list(fmt_xx, fmt_xx_x, fmt_xx_xx, fmt_xx_xxx, fmt_xx_xxxx), function(fmt) {
    lyt_default %>% 
        analyze(vars = "AGE", afun = mean, format = fmt) %>%
        build_table(ADSL)
})

```


##### Zero to Four Decimal Places with Percentage

The following formats can be used to display values with zero to four decimal places which are in percentage format:

```{r, echo=FALSE}
fmt_pxx <- "xx%"
fmt_pxx_x <- "xx.%"
fmt_pxx_xx <- "xx.x%"
fmt_pxx_xxx <- "xx.xx%"
fmt_pxx_xxxx <- "xx.xxx%"

# Apply is used to quickly iterate over the list of formats defined above.
# Note: The afun function is used to divide the mean by 100 to get a percentage value.
lapply(list(fmt_pxx, fmt_pxx_x, fmt_pxx_xx, fmt_pxx_xxx, fmt_pxx_xxxx), function(fmt) {
    lyt_default %>% 
        analyze(vars = "AGE", afun = function(x){mean(x)/100}, format = fmt) %>%
        build_table(ADSL)
})
```

##### Miscellaneous Formats

The following formats can be used to display various values that can be used in statistical tables:

```{r, echo=FALSE}
fmt_nxx <- "(N=xx)"
fmt_999x <- ">999.9"
fmt_999xx <- ">999.99"
fmt_pval <- "x.xxxx | (<0.0001)"

# In this example we assume the raw value in afun is a sample size.
lyt_default %>% 
        analyze(vars = "AGE", afun = sum, format = fmt_nxx) %>%
        build_table(ADSL)

# In the following two examples, we assume the raw value in afun is a value that exceeds a certain threshold.
lyt_default %>% 
        analyze(vars = "AGE", afun = function(x){mean(x)*100}, format = fmt_999x) %>%
        build_table(ADSL)

lyt_default %>% 
        analyze(vars = "AGE", afun = function(x){mean(x)*100}, format = fmt_999xx) %>%
        build_table(ADSL)

lyt_default %>% 
        analyze(vars = "AGE", afun = function(x){mean(x)/1e9}, format = fmt_pval) %>%
        build_table(ADSL)

```



#### Examples of 2d labels

You can include R code in the document as follows:

```{r exampled2d, echo=FALSE}

```

#### Examples of 3d labels

You can include R code in the document as follows:

```{r exampled2d, echo=FALSE}

```
